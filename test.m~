for i = 3:44
    for tn = 1 :length(start_tr)
        % prepare the individual trials to be saved as the
        % fileds of a structre to make loading easier
        eval(['Pall.PSD',num2str(tn),' = D.Pow_Norm_stim{', num2str(tn), '};']);
    end
    
    saveName = ['Raw_PSD_B',num2str(i) ,'.mat'];
    load(saveName);
    A = whos('-file', saveName);
    for ch = 1:size(PSD1 , 1)
        for tr = 1:length(A)
            eval(['Pall.PSD',num2str(tr),' = 10*log10(PSD',num2str(tr) , ');']);
            X = abs(REG(:,start_tr(tr)-floor(Fs_ds*TimeDelay) : end_tr(tr)+floor(Fs_ds*2*TimeDelay)));
            X = 10*log10((X - repmat(baseline , 1,size(X,2)))./repmat(baseline , 1,size(X,2)));
            statement1 = ['Pall.PSD{tr,1}(ch , :,:)  = X;'];
            eval(statement1);
        end
        disp(['PSD calculation for block ' , num2str(i) , ', channel ' , num2str(ch) , ' completed'])
        clear Pall
    end
end
%% Calculate the PSDs
load('AllData_Behav.mat')
chans = [3:15 , 99:109 , 121:129 ,36];
Dout  = secog_parseEEG_PSD('ParseEEG-calcPSD' , Dall, 1 , 'Channels' , chans);
% time warp
Dout  = secog_parseEEG_PSD('TimeWarpPSD_Raw_Binned' , Events, 1);
cd('/Volumes/MotorControl/data/SeqECoG/ecog1/iEEG data/P2')
load('AllData_PSD_Warped.mat')
secog_BlockGroupAverage(Pall,1,'raw_BlockGroup')

cd('/Volumes/MotorControl/data/SeqECoG/ecog1/iEEG data/P2')
load('AllData_PSD_Warped.mat')
secog_BlockGroupAverage(Pall,1,'binned_BlockGroup')

%%





secog_BlockGroupAverage(Pall,1,'raw_BlockGroup')


blockGroupNames = {'SingleFingNat' , 'SingleFingSlow' , 'SingleFingFast' , 'Intermixed1' , 'Intermixed2' , 'ChunkDay1' , 'Intermixed3' , 'Intermixed4' , 'Intermixed5',...
    'ChunkDay2' , 'Intermixed6' , 'Intermixed7' , 'Intermixed8', 'ChunkDay3', 'Intermixed9'}';

load('AllData_PSD_StimNorm.mat')
secog_visualizePSD(Pall,1,'binned_SingleTrial' , 'TBNum', [10 4], 'Chan2Plot' , [104:107 , 109])
secog_visualizePSD(Pall,1,'binned_SingleTrial_AvgChann' , 'TBNum', [10 40], 'Chan2Plot' , [104:107 , 109])
secog_visualizePSD(Pall,1,'raw_SingleTrial' , 'TBNum', [1 1], 'Chan2Plot' , [104:107 , 109])


%%
load('AllData_PSD_Warped.mat')
% PMD layer 2
secog_visualizePSD(Pall,1,'binned_BlockGroup_AvgChann' , 'BlockGroup' , 'SingleFingSlow','Chan2Plot' , [104:107 , 109])
secog_visualizePSD(Pall,1,'binned_BlockGroup' , 'BlockGroup' , 'SingleFingSlow','Chan2Plot' , [104:107 , 109])
% PMD layer 1
secog_visualizePSD(Pall,1,'binned_BlockGroup' , 'BlockGroup' , 'SingleFingSlow','Chan2Plot' , [12 14])
% PMv
secog_visualizePSD(Pall,1,'binned_BlockGroup' , 'BlockGroup' , 'SingleFingSlow','Chan2Plot' , [6])
% SMA
secog_visualizePSD(Pall,1,'binned_BlockGroup' , 'BlockGroup' , 'SingleFingSlow','Chan2Plot' , [123:126])
secog_visualizePSD(Pall,1,'binned_BlockGroup' , 'BlockGroup' , blockGroupNames{3},'Chan2Plot' , [123:126])


